<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒˆãƒ³ã«ãã‚²ãƒ¼ãƒ </title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    text-align: center;
    background: #f2f2f2;
    padding: 20px;
  }
  h2 { margin-bottom: 10px; }
  .scoreboard { font-size: 20px; margin-bottom: 15px; }
  table { margin: 0 auto; border-collapse: collapse; width: 90%; max-width: 400px; }
  td {
    border: 1px solid #aaa;
    height: 60px;
    font-size: 28px;
    text-align: center;
    background: #fff;
  }
  tr.active td { background-color: #ffe58a; } /* â† ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
  button {
    width: 120px;
    padding: 12px;
    margin: 8px;
    font-size: 18px;
    border: none;
    border-radius: 8px;
    background-color: #4CAF50;
    color: white;
    cursor: pointer;
  }
  button:active { background-color: #45a049; }
  canvas { margin-top: 20px; width: 90%; max-width: 400px; }
  @media (max-width: 480px) {
    td { height: 50px; font-size: 22px; }
    button { width: 45%; font-size: 16px; padding: 10px; }
  }
</style>
</head>
<body>
<h2>ğŸ® ãƒˆãƒ³ã«ãã‚²ãƒ¼ãƒ </h2>
<div class="scoreboard">
  <strong>ã‚¹ã‚³ã‚¢:</strong> <span id="current">0</span>ã€€
  <strong>æœ€é«˜ã‚¹ã‚³ã‚¢:</strong> <span id="best">0</span>
</div>
<table id="board"></table>
<div>
  <button id="ton">ãƒˆãƒ³</button>
  <button id="nigi">ã«ã</button>
</div>
<p>ç¾åœ¨ã®è¡Œ: <span id="rowIndex">1</span></p>
<canvas id="scoreChart"></canvas>

<script>
const symbols = ["â—‹", "â˜…", "â–²"];
const map = {
  "": "ãƒˆãƒ³ãƒˆãƒ³",
  "â–²": "ã«ãã«ã",
  "â˜…": "ãƒˆãƒ³ã«ã",
  "â—‹": "ã«ããƒˆãƒ³"
};
let bestScore = 0;
let scoreHistory = [];
let currentRow = 0;
let chart;

// å±¥æ­´èª­ã¿è¾¼ã¿
window.onload = () => {
  const savedBest = localStorage.getItem("bestScore");
  const savedHistory = localStorage.getItem("scoreHistory");
  if (savedBest) {
    bestScore = parseInt(savedBest);
    document.getElementById("best").textContent = bestScore;
  }
  if (savedHistory) scoreHistory = JSON.parse(savedHistory);
  createBoard();
  randomSetup();
  highlightRow();
  drawChart();
};

// ç›¤é¢ä½œæˆ
function createBoard() {
  const board = document.getElementById("board");
  board.innerHTML = "";
  for (let r = 0; r < 3; r++) {
    const row = document.createElement("tr");
    for (let c = 0; c < 3; c++) {
      const cell = document.createElement("td");
      row.appendChild(cell);
    }
    const recordCell = document.createElement("td");
    recordCell.style.fontSize = "18px";
    row.appendChild(recordCell);
    board.appendChild(row);
  }
}

// å‡ºç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼ˆ2,2,2 or 3,2,1ï¼‰
function randomSetup() {
  const board = document.getElementById("board");
  const pattern = Math.random() < 0.5 ? [2,2,2] : [3,2,1];
  const shuffledSymbols = shuffle(symbols.slice());
  const allSymbols = [];
  for (let i = 0; i < 3; i++) {
    for (let j = 0; j < pattern[i]; j++) allSymbols.push(shuffledSymbols[i]);
  }
  while (allSymbols.length < 9) allSymbols.push(symbols[Math.floor(Math.random()*3)]);
  const final = shuffle(allSymbols).slice(0,9);

  const cells = board.querySelectorAll("td");
  let index = 0;
  for (let r = 0; r < 3; r++) {
    for (let c = 0; c < 3; c++) {
      cells[r*4 + c].textContent = final[index++];
    }
    cells[r*4 + 3].textContent = "";
  }
  document.getElementById("current").textContent = 0;
  currentRow = 0;
  highlightRow();
}

// ã‚·ãƒ£ãƒƒãƒ•ãƒ«
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// ã€Œãƒˆãƒ³ã€ã€Œã«ãã€ãƒœã‚¿ãƒ³
document.getElementById("ton").onclick = () => recordMove("ãƒˆãƒ³");
document.getElementById("nigi").onclick = () => recordMove("ã«ã");

function recordMove(move) {
  const board = document.getElementById("board");
  const recordCell = board.rows[currentRow].cells[3];
  recordCell.textContent += move;
  // è‡ªå‹•æ¡ç‚¹ï¼†æ¬¡ã®è¡Œã¸
  if (recordCell.textContent.length >= 6) {
    autoCheckRow(currentRow);
    nextRow();
  }
}

// è¡Œåˆ‡ã‚Šæ›¿ãˆ
function nextRow() {
  const board = document.getElementById("board");
  board.rows[currentRow].classList.remove("active");
  currentRow = (currentRow + 1) % 3;
  document.getElementById("rowIndex").textContent = currentRow + 1;
  highlightRow();
  if (currentRow === 0) {
    autoCheckAll();
    setTimeout(randomSetup, 1500); // æ¬¡ã®é…ç½®
  }
}

// ãƒã‚¤ãƒ©ã‚¤ãƒˆ
function highlightRow() {
  const board = document.getElementById("board");
  for (let r = 0; r < 3; r++) board.rows[r].classList.remove("active");
  board.rows[currentRow].classList.add("active");
}

// è‡ªå‹•æ¡ç‚¹ï¼ˆ1è¡Œï¼‰
function autoCheckRow(r) {
  const board = document.getElementById("board");
  const correctMoves = [];
  for (let c = 0; c < 3; c++) {
    const sym = board.rows[r].cells[c].textContent;
    correctMoves.push(map[sym] || "ãƒˆãƒ³ãƒˆãƒ³");
  }
  const correct = correctMoves.join("");
  const answer = board.rows[r].cells[3].textContent;
  if (answer === correct) {
    board.rows[r].cells[3].style.background = "#b7f5c4";
  } else {
    board.rows[r].cells[3].style.background = "#f7b0b0";
  }
}

// å…¨ä½“æ¡ç‚¹
function autoCheckAll() {
  const board = document.getElementById("board");
  let score = 0;
  for (let r = 0; r < 3; r++) {
    const correctMoves = [];
    for (let c = 0; c < 3; c++) {
      const sym = board.rows[r].cells[c].textContent;
      correctMoves.push(map[sym] || "ãƒˆãƒ³ãƒˆãƒ³");
    }
    const correct = correctMoves.join("");
    const answer = board.rows[r].cells[3].textContent;
    if (answer === correct) score++;
  }
  document.getElementById("current").textContent = score;
  scoreHistory.push(score);
  localStorage.setItem("scoreHistory", JSON.stringify(scoreHistory));
  if (score > bestScore) {
    bestScore = score;
    localStorage.setItem("bestScore", bestScore);
    document.getElementById("best").textContent = bestScore;
  }
  drawChart();
}

// ã‚°ãƒ©ãƒ•æç”»
function drawChart() {
  const ctx = document.getElementById("scoreChart").getContext("2d");
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: scoreHistory.map((_, i) => i + 1),
      datasets: [{
        label: "ã‚¹ã‚³ã‚¢å±¥æ­´",
        data: scoreHistory,
        borderColor: "#4CAF50",
        borderWidth: 2,
        fill: false,
        tension: 0.2
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: { title: { display: true, text: "ãƒ—ãƒ¬ã‚¤å›æ•°" } },
        y: { beginAtZero: true, ticks: { stepSize: 1 }, title: { display: true, text: "ã‚¹ã‚³ã‚¢" } }
      }
    }
  });
}
</script>
</body>
</html>

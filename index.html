<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>にぎトン〇</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f0f1a;
    --panel:#1a1a2e;
    --neon:#00ffff;
    --accent:#00ffcc;
    --ok:#00ff66;
    --bad:#ff4d4d;
  }

  html,body { height:100%; }
  body {
    touch-action: manipulation;
    -ms-touch-action: manipulation;
    font-family: "Segoe UI", sans-serif;
    text-align: center;
    background: var(--bg);
    color: #ffffff;
    margin: 0;
    padding: 20px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }

  h1 { margin: 6px 0 0 0; font-size:28px; letter-spacing:1px; }

  .status { font-size:16px; margin:6px 0; }

  table { margin: 6px auto; border-collapse: separate; border-spacing: 4px;}
  td {
    border: 2px solid var(--neon);
    width: 80px;
    height: 80px;  
    padding:6px;
    box-sizing:border-box;
    background: var(--panel);
    box-shadow: 0 0 12px rgba(0,255,255,0.08);
    position:relative;
    vertical-align:middle;
    text-align:center;
    border-radius:8px;
    transition: box-shadow .18s, transform .08s, border-color .18s;
  }
  .cell-symbol { display:block; font-size:36px; line-height:1; }
  .cell-input { display:block; font-size:12px; color: #cfe; margin-top:4px; opacity:0.9; }
  .cell-feedback {
    position:absolute; inset:6px;
    border-radius:8px;
    pointer-events:none;
  }

  td.current {
    box-shadow: 0 0 20px var(--accent);
    transform: translateY(-4px);
    z-index: 1;   
  }

  td.correct { border-color: var(--ok); box-shadow: 0 0 18px rgba(0,255,102,0.18); }
  td.wrong { border-color: var(--bad); box-shadow: 0 0 18px rgba(255,77,77,0.18); opacity:0.95; }

  .controls { display:flex; flex-wrap:wrap; justify-content:center; gap:8px; margin-top:6px; }
  button {
    font-size:18px;
    margin: 6px;
    padding: 12px 28px;
    border-radius: 12px;
    border: 2px solid var(--accent);
    color: var(--accent);
    background: transparent;
    box-shadow: 0 0 12px rgba(0,255,204,0.06);
    min-width:98px;
  }
  button:active { transform: translateY(2px); background: var(--accent); color:#000; }

  .small { font-size:13px; color:#ddd; }
  /*canvas { margin-top: 12px; width: 90%; max-width: 420px; }

  /* モバイルでタップしやすく */
  @media (max-width:480px){
    td{ width:72px; height:72px; font-size:28px; }
    button{ font-size:18px; padding:14px 26px; min-width:86px; }
    h1{ font-size:22px; }
  }
</style>
</head>
<body>

<h1>にぎトン〇</h1>
<p class="status"><b>スコア:</b> <span id="score">0</span>　
<b>ベスト:</b> <span id="best">0</span></p>

<table id="board" aria-label="ゲーム盤"></table>

<div class="button-container">
  <div class="top-buttons">
    <button id="fullscreen">フルスクリーン</button>
    <button id="start">スタート</button>
  </div>
  <div class="game-buttons">
    <button id="ton">トン</button>
    <button id="nigi">にぎ</button>
  </div>
</div>

<canvas id="chart" aria-hidden="false"></canvas>

<script>
/* ---------- 設定 ---------- */
const symbols = ["○","★","▲"," "]; // 空はマス無し（スキップ）
const expectedSeq = {
  "○": ["にぎ","トン"],
  "★": ["トン","にぎ"],
  "▲": ["にぎ","にぎ"],
  " ": ["トン","トン"]
};
/* ------------------------- */

const board = document.getElementById("board");
let currentRow = 0;
let currentCol = 0;
let score = 0;
let best = Number(localStorage.getItem("best") || 0);
let history = JSON.parse(localStorage.getItem("hist") || "[]");
let chart = null;

document.getElementById("best").textContent = best;

 // 起動時リセット
localStorage.removeItem("hist");
localStorage.removeItem("best");
history = [];
best = 0;
document.getElementById("best").textContent = 0;
/* グラフ描画 */
  
function drawChart(){
  const ctx = document.getElementById("chart").getContext("2d");
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: history.map((_,i)=>i+1),
      datasets: [{ label: "スコア履歴", data: history, borderColor: "#4CAF50", fill:false, tension:0.2 }]
    },
    options: { scales: { y: { beginAtZero:true, ticks:{ stepSize:1 }}}}
  });
}
/*drawChart();

/* 盤面生成（3行×3列） */
function makeBoard(){
  board.innerHTML = "";
  for (let r=0;r<3;r++){
    const tr = document.createElement("tr");
    for (let c=0;c<3;c++){
      const td = document.createElement("td");
      td.classList.add("cell");
      td.dataset.r = r;
      td.dataset.c = c;
      td.dataset.symbol = "";
      td.dataset.input = ""; // 入力履歴（カンマ区切り）
      td.innerHTML = `<span class="cell-symbol"></span><span class="cell-input"></span><div class="cell-feedback"></div>`;
      tr.appendChild(td);
    }
    board.appendChild(tr);
  }
}
makeBoard();

/* ランダム盤面作成（記号をバランスよく配置） */
function shuffle(arr){
  for (let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function generateBalancedSymbols(){
  // 合計9マス分の記号（空含む）を作る
  const all = [];
  // simple approach: ensure each symbol appears at least twice, then fill rest
  const base = ["○","★","▲"];
  for (const s of base) { all.push(s); all.push(s); } // 各2個 = 6
  all.push(" "); all.push(" "); all.push(" "); // 空3個 = 9
  return shuffle(all);
}

/* スタート処理 */
document.getElementById("start").addEventListener("click", startGame);
function startGame(){
  score = 0;
  currentRow = 0; currentCol = 0;
  const symbolsArr = generateBalancedSymbols();
  // 配置（3x3）
  for (let i=0;i<9;i++){
    const r = Math.floor(i/3);
    const c = i%3;
    const td = board.rows[r].cells[c];
    const sym = symbolsArr[i];
    td.dataset.symbol = sym;
    td.dataset.input = "";
    td.classList.remove("correct","wrong","current");
    td.querySelector(".cell-symbol").textContent = sym; // 表示する
    td.querySelector(".cell-input").textContent = ""; 
  }
  highlightCell(0,0);
  document.getElementById("score").textContent = score;
}

/* ハイライト */
function highlightCell(r,c){
  // remove all current
  for (let rr=0; rr<3; rr++) for (let cc=0; cc<3; cc++){
    board.rows[rr].cells[cc].classList.remove("current");
  }
  const td = board.rows[r].cells[c];
  td.classList.add("current");
}

/* ボタン操作（タッチ対応） */
const tonBtn = document.getElementById("ton");
const nigiBtn = document.getElementById("nigi");

function makeHandler(action){
  return function(e){
    if (e && e.type === "touchstart") { e.preventDefault(); } // prevent delayed click
    handleInput(action);
  };
}
tonBtn.addEventListener("click", makeHandler("トン"));
nigiBtn.addEventListener("click", makeHandler("にぎ"));
tonBtn.addEventListener("touchstart", makeHandler("トン"), { passive:false });
nigiBtn.addEventListener("touchstart", makeHandler("にぎ"), { passive:false });

/* 入力処理（1マスずつ） */
function handleInput(action){
  const td = board.rows[currentRow].cells[currentCol];
  const sym = td.dataset.symbol || "";
  const expect = expectedSeq[sym] || [];
  // append input
  const inputs = td.dataset.input ? td.dataset.input.split(",") : [];
  if (inputs.length >= expect.length) return; // すでに完了
  td.classList.remove("correct","wrong");
  inputs.push(action);
  td.dataset.input = inputs.join(",");
  td.querySelector(".cell-input").textContent = inputs.join(" ");

  // 判定（完了したら） 
  if (inputs.length === expect.length){
    const ok = inputs.every((v,i)=>v === expect[i]);
    if (ok){
      td.classList.add("correct");
      score += 1;
    } else {
      td.classList.add("wrong");
    }
    document.getElementById("score").textContent = score;
    // 少しだけ表示して次のセルへ
    setTimeout(moveNextCell, 300);
  }
}

/* 次のセルへ（行内→次行→終了） */
function moveNextCell(){
  // remove current class from current cell
  const curTd = board.rows[currentRow].cells[currentCol];
  curTd.classList.remove("current");
  // advance column
  currentCol++;
  if (currentCol >= 3){
    // 次の行
    currentCol = 0;
    currentRow++;
    if (currentRow >= 3){
      // ゲーム終了
      finishGame();
      return;
    }
  }
  highlightCell(currentRow, currentCol);
}

/* ゲーム終了 */
function finishGame(){
  // 保存
  history.push(score);
  localStorage.setItem("hist", JSON.stringify(history));
  if (score > best){
    best = score;
    localStorage.setItem("best", best);
  }
  document.getElementById("best").textContent = best;
  /*drawChart();*/
  // 結果パネル（簡易）
  /*setTimeout(()=> {
    alert(`ゲーム終了！ スコア: ${score}`);
  }, 120);*/
  startGame();
}

/* フルスクリーンはPCのみ表示 */
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
if (isMobile){
  document.getElementById("fullscreen").style.display = "none";
} else {
  document.getElementById("fullscreen").addEventListener("click", () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  });
}

/* 起動時に盤面作成だけ（スタートで初期化） */
startGame();

</script>
</body>
</html>

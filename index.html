<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>トンにぎゲーム</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  text-align: center;
  background: #0f0f1a;
  color: #ffffff;
  margin: 0;
  padding: 20px;
  touch-action: manipulation;
}

table {
  margin: 10px auto;
  border-collapse: collapse;
}
td {
  border: 2px solid #00ffff;
  width: 70px;
  height: 70px;
  font-size: 32px;
  text-align: center;
  background: #1a1a2e;
  box-shadow: 0 0 10px #00ffff;
  position: relative;
}
td.correct { background-color: #0f0; color:#000; }
td.wrong { background-color: #f00; color:#000; }

tr.active { background: #ad9452; }

button {
  font-size: 20px;
  margin: 6px;
  padding: 12px 24px;
  border-radius: 10px;
  border: 2px solid #00ffcc;
  color: #00ffcc;
  background: transparent;
  box-shadow: 0 0 10px #00ffcc;
}
button:active {
  background: #00ffcc;
  color: #000;
}

canvas{ margin-top:12px; width:90%; max-width:400px; height:120px; }
</style>
</head>
<body>

<h1>トンにぎゲーム</h1>
<p><b>スコア:</b> <span id="score">0</span>　
<b>ベスト:</b> <span id="best">0</span></p>

<table id="board"></table>

<div>
  <button id="fullscreen">フルスクリーン</button>
  <button id="start">スタート</button><br>
  <button id="ton">トン</button>
  <button id="nigi">にぎ</button>
</div>

<canvas id="chart"></canvas>

<script>
const symbols = ["○","★","▲"];
const map = { "○":["にぎ","トン"], "★":["トン","にぎ"], "▲":["にぎ","にぎ"], "":[""] };

let board = document.getElementById("board");
let currentRow = 0;
let currentCol = 0;
let score = 0;
let best = parseInt(localStorage.getItem("best")||0);
let history = JSON.parse(localStorage.getItem("hist")||"[]");
let chart;

document.getElementById("best").textContent = best;

// グラフ描画
function drawChart(){
  const ctx = document.getElementById("chart").getContext("2d");
  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:"line",
    data:{
      labels: history.map((_,i)=>i+1),
      datasets:[{label:"スコア履歴", data: history, borderColor:"#4CAF50", fill:false, tension:0.2}]
    },
    options:{scales:{y:{beginAtZero:true, ticks:{stepSize:1}}}}
  });
}
drawChart();

// 盤面生成
function createBoard(){
  board.innerHTML="";
  for(let r=0;r<3;r++){
    const row = document.createElement("tr");
    for(let c=0;c<3;c++){
      const td = document.createElement("td");
      td.dataset.symbol = "";
      td.dataset.input = "";
      td.innerHTML='<span class="cell-input"></span>';
      row.appendChild(td);
    }
    row.appendChild(document.createElement("td")); // 判定表示用スペース
    board.appendChild(row);
  }
}

// スタート
document.getElementById("start").onclick=startGame;
function startGame(){
  score=0;
  currentRow=0;
  currentCol=0;
  document.getElementById("score").textContent=0;
  const all = generateBalancedSymbols();
  for(let i=0;i<9;i++){
    const r = Math.floor(i/3);
    const c = i%3;
    const td = board.rows[r].cells[c];
    td.dataset.symbol = all[i];
    td.dataset.input = "";
    td.querySelector(".cell-input").textContent = all[i];
    td.classList.remove("correct","wrong");
  }
  highlightRow(0);
}

// ハイライト
function highlightRow(i){
  for(let r=0;r<3;r++) board.rows[r].classList.remove("active");
  board.rows[i].classList.add("active");
}

// フルスクリーン
if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)){
  document.getElementById("fullscreen").style.display="none";
}else{
  document.getElementById("fullscreen").onclick=()=> {
    if(!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
  };
}

// トン・にぎボタン
function record(action){
  const td = board.rows[currentRow].cells[currentCol];
  td.classList.remove("correct","wrong");

  let inputs = td.dataset.input? td.dataset.input.split(",") : [];
  inputs.push(action);
  td.dataset.input = inputs.join(",");

  td.querySelector(".cell-input").textContent = inputs.join(" ");

  const correctSeq = map[td.dataset.symbol]||[];
  if(inputs.length >= correctSeq.length){
    const ok = inputs.every((v,i)=>v===correctSeq[i]);
    td.classList.add(ok?"correct":"wrong");
    if(ok) score+=1;
    document.getElementById("score").textContent=score;
    currentCol++;
    if(currentCol>=3){
      currentCol=0;
      currentRow++;
      if(currentRow>=3){
        finish();
      }else highlightRow(currentRow);
    }
  }
}

document.getElementById("ton").addEventListener("click",()=>record("トン"));
document.getElementById("nigi").addEventListener("click",()=>record("にぎ"));
document.getElementById("ton").addEventListener("touchstart", e=>{e.preventDefault();record("トン");},{passive:false});
document.getElementById("nigi").addEventListener("touchstart", e=>{e.preventDefault();record("にぎ");},{passive:false});

// ゲーム終了
function finish(){
  history.push(score);
  localStorage.setItem("hist",JSON.stringify(history));
  if(score>best){
    best=score;
    localStorage.setItem("best",best);
  }
  document.getElementById("best").textContent=best;
  drawChart();
}

// 記号をランダムに生成
function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}
function generateBalancedSymbols(){
  const all=[]; 
  const pattern=Math.random()<0.5?"even":"mixed"; 
  const counts={}; 
  if(pattern==="even"){ for(const s of symbols) counts[s]=3; }
  else{
    const base=[3,2,1];
    const shuffled=shuffle(base);
    for(let i=0;i<3;i++) counts[symbols[i]]=shuffled[i];
  }
  for(const s of symbols) for(let i=0;i<counts[s];i++) all.push(s);
  while(all.length<9) all.push('');
  return shuffle(all);
}

createBoard();
</script>
</body>
</html>

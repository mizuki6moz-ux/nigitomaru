<!DOCTYPE html>
<html lang="ja">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>トンにぎゲーム</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
  font-family: "Segoe UI", sans-serif;
  text-align: center;
  background: #0f0f1a;
  color: #ffffff;
  margin: 0;
  padding: 20px;
  }

  table {
    margin: 10px auto;
    border-collapse: collapse;
  }
  td {
  border: 2px solid #00ffff;
  width: 70px;
  height: 70px;
  font-size: 32px;
  text-align: center;
  background: #1a1a2e;
  box-shadow: 0 0 10px #00ffff;
  }
  tr.active {
    background: #ad9452;
  }
  button {
  font-size: 20px;
  margin: 6px;
  padding: 12px 24px;
  border-radius: 10px;
  border: 2px solid #00ffcc;
  color: #00ffcc;
  background: transparent;
  box-shadow: 0 0 10px #00ffcc;
  }
  button:active {
  background: #00ffcc;
  color: #000;
  }

  button:active { background: #45a049; }
  canvas { margin-top: 20px; width: 90%; max-width: 400px; }
</style>
</head>
<body>

<h1>トンにぎゲーム</h1>
<p><b>スコア:</b> <span id="score">0</span>　
<b>ベスト:</b> <span id="best">0</span></p>

<table id="board"></table>

<div>
  <button id="fullscreen">フルスクリーン</button>
  <button id="start">スタート</button><br>
  <button id="ton">トン</button>
  <button id="nigi">にぎ</button>
</div>

<canvas id="chart"></canvas>

<script>

const symbols = ["○", "★", "▲"];
const map = { "○":"にぎトン", "★":"トンにぎ", "▲":"にぎにぎ" ,"":"トントン"};
let board = document.getElementById("board");
let currentRow = 0;
let rowStart = 0;
let score = 0;
let best = localStorage.getItem("best") || 0;
let history = JSON.parse(localStorage.getItem("hist")) || [];
let chart;

// 起動時リセット
localStorage.removeItem("hist");
localStorage.removeItem("best");
history = [];
best = 0;
document.getElementById("best").textContent = 0;


document.getElementById("best").textContent = best;

// 盤面生成
for (let r=0; r<3; r++){
  const row=document.createElement("tr");
  for (let c=0; c<3; c++){
    const td=document.createElement("td");
    td.textContent="";
    row.appendChild(td);
  }
  const rec=document.createElement("td");
  rec.textContent="";
  rec.style.fontSize="13px";
  row.appendChild(rec);
  board.appendChild(row);
}

// スタート
document.getElementById("start").onclick = startGame;
function startGame(){
  score=0;
  currentRow=0;
  const all = generateBalancedSymbols();
  // 9個をしっかり3×3に配置
  for (let i=0;i<9;i++) {
    const r = Math.floor(i / 3);
    const c = i % 3;
    board.rows[r].cells[c].textContent = all[i];
  }
  for (let r=0;r<3;r++) board.rows[r].cells[3].textContent="";
  highlightRow(0);
  rowStart=Date.now();
  document.getElementById("score").textContent=0;
}
//フルスクリーン
document.getElementById("fullscreen").onclick = () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
};



// トン・にぎ押下
document.getElementById("ton").onclick=()=> record("トン");
document.getElementById("nigi").onclick=()=> record("にぎ");

function record(action){
  const row=board.rows[currentRow];
  row.cells[3].textContent+=action;
  const ans=row.cells[3].textContent;
  const correct=Array.from(row.cells).slice(0,4).map(c=>map[c.textContent]||"").join("");
  if(ans.length>=12){
    const time=(Date.now()-rowStart)/1000;
    let rowScore=(ans===correct)?Math.max(1,Math.floor(5-time)):0;
    score+=rowScore;
    document.getElementById("score").textContent=score;
    nextRow();
  }
}

// 次の行へ
function nextRow(){
  board.rows[currentRow].classList.remove("active");
  currentRow++;
  if(currentRow<3){
    highlightRow(currentRow);
    rowStart=Date.now();
  }else finish();
}

// ハイライト
function highlightRow(i){
  for (let r=0;r<3;r++) board.rows[r].classList.remove("active");
  board.rows[i].classList.add("active");
}

// ゲーム終了
function finish(){
  history.push(score);
  localStorage.setItem("hist",JSON.stringify(history));
  if(score>best){
    best=score;
    localStorage.setItem("best",best);
  }
  document.getElementById("best").textContent=best;
  drawChart();
  alert(`スコア: ${score}`);
}

// 記号をバランスよく生成（3,2,1 または 2,2,2）
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function generateBalancedSymbols(){
  const all=[];
  const pattern=Math.random()<0.5?"even":"mixed";
  const counts={};
  if(pattern==="even"){ for(const s of symbols) counts[s]=2; } // ←ここ修正：各3個で9マス
  else{
    const base=[3,2,1];
    const shuffled=shuffle(base);
    for(let i=0;i<3;i++) counts[symbols[i]]=shuffled[i];
  }
  for(const s of symbols) for(let i=0;i<counts[s];i++) all.push(s);
  for(let i=0;i<3;i++) all.push('');
  return shuffle(all);
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}


// グラフ
function drawChart(){
  const ctx=document.getElementById("chart").getContext("2d");
  if(chart)chart.destroy();
  chart=new Chart(ctx,{
    type:"line",
    data:{
      labels:history.map((_,i)=>i+1),
      datasets:[{label:"スコア履歴",data:history,borderColor:"#4CAF50",fill:false,tension:0.2}]
    },
    options:{scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}
  });
}
drawChart();
</script>
</body>
</html>
